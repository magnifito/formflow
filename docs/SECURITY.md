# Security Documentation

FormFlow implements multiple layers of security to protect against spam, abuse, and malicious activity while maintaining ease of use for legitimate users.

## Overview

Security is implemented at two levels:
- **Collector API**: Public-facing form submission endpoint with anti-spam measures
- **Dashboard API**: Admin interface with authentication and authorization

---

## Collector API Security

### 1. Rate Limiting

Per-IP and per-form rate limiting prevents spam attacks:

**Per-Minute Limits:**
- Configurable max requests per minute per IP/form combination
- Default: 10 requests per minute
- Tracks requests using in-memory cache

**Per-Hour Limits:**
- Configurable max requests per hour per IP/form combination
- Default: 50 requests per hour
- Prevents sustained spam campaigns

**Minimum Time Between Submissions:**
- Configurable minimum seconds between submissions from same IP/form
- Default: 5 seconds
- Prevents rapid automated submissions

**Implementation:**
- In-memory Map with automatic cleanup every 5 minutes
- Returns `429 Too Many Requests` when limit exceeded
- Response headers include: `X-RateLimit-Limit`, `X-RateLimit-Remaining`, `X-RateLimit-Reset`

### 2. Proof of Work CAPTCHA (Alcha)

Client-side proof-of-work challenge system:

**How it Works:**
1. Client requests challenge from `/challenge/:apikey` endpoint
2. Server generates cryptographic challenge
3. Client must solve computation before submission
4. Server validates solution on submission

**Benefits:**
- No user interaction required (invisible CAPTCHA)
- Significantly slows down bot submissions
- No third-party dependencies (privacy-friendly)
- Works on all platforms/browsers

**Validation:**
- Validates `x-altcha-spam-filter` header on submission
- Rejects submissions without valid proof of work
- Challenge expires after configurable TTL

### 3. CSRF Protection

Optional CSRF token validation for enhanced security:

**Configuration:**
- `CSRF_SECRET`: Secret for signing tokens
- `CSRF_TTL_MINUTES`: Token expiration time (default: 15 minutes)

**How it Works:**
1. Generate CSRF token for form session
2. Include token in form submission
3. Server validates token signature and expiration
4. Rejects submissions with invalid/expired tokens

**Headers:**
- `X-CSRF-Token`: Token included in submission request

### 4. Domain Whitelisting

Restrict form submissions to approved domains:

**Features:**
- Per-form whitelist configuration
- Checks `Origin` header with `Referer` fallback
- Allows `localhost` for development
- Returns `403 Forbidden` for unauthorized domains

**Origin Detection:**
1. Check `Origin` header (modern browsers)
2. Fall back to `Referer` header if `Origin` missing
3. Extract domain from URL
4. Validate against whitelist

### 5. Request Validation

Multiple layers of request validation:

**Body Size Limits:**
- Express `bodyParser` limit: ~100KB
- Prevents DoS via oversized requests
- Rejects early if exceeded

**Content-Type Validation:**
- Requires `application/json` for JSON submissions
- Rejects suspicious content types
- Prevents injection attacks

**Input Sanitization:**
- Maximum message length: 4000 characters
- Empty message rejection
- Field-level validation

### 6. Encrypted Fields

Sensitive form fields can be encrypted at rest:

**Implementation:**
- AES-256-CBC encryption
- `ENCRYPTION_KEY` environment variable (32 characters)
- Fields marked as encrypted in form config
- Decrypted only when needed by authorized users

**Use Cases:**
- PII (Personal Identifiable Information)
- Payment information
- Medical records
- Confidential data

### 7. Security Headers

HTTP security headers added to responses:

```javascript
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
```

**Additional Headers (production):**
- `Strict-Transport-Security` for HTTPS enforcement
- `Content-Security-Policy` for XSS protection

---

## Dashboard API Security

### 1. Authentication

**Telegram OAuth:**
- Telegram Bot authentication flow
- JWT tokens for session management
- bcrypt password hashing for super admin accounts

**Session Management:**
- JWT with configurable expiration
- `JWT_SECRET` environment variable
- Secure cookie storage (httpOnly, sameSite)

### 2. Authorization

**Role-Based Access Control:**
- Super Admin: Full system access
- Organization Admin: Organization-scoped access
- User: Limited to assigned organizations

**Organization Context:**
- Middleware validates organization membership
- Header: `X-Organization-Context`
- Data isolation per organization

### 3. API Key Management

**Features:**
- Unique API key per organization
- Used to identify form submissions
- Validated on every request
- Can be regenerated by organization admins

---

## Environment Variables

### Required (Collector API)

```bash
# Database
DEV_DB_HOST=postgres
DEV_DB_PORT=5432
DEV_DB=formflow
DEV_DB_USER=formflow
DEV_DB_PASS=your_secure_password

# Encryption
ENCRYPTION_KEY=your-32-character-encryption-key

# HMAC for PoW CAPTCHA
HMAC=your-hmac-secret-key
```

### Optional (Collector API)

```bash
# CSRF Protection
CSRF_SECRET=your-csrf-secret
CSRF_TTL_MINUTES=15

# Rate Limiting (future config)
RATE_LIMIT_PER_MINUTE=10
RATE_LIMIT_PER_HOUR=50
MIN_SECONDS_BETWEEN_SUBMISSIONS=5
```

### Required (Dashboard API)

```bash
# Database
DEV_DB_HOST=postgres
DEV_DB_PORT=5432
DEV_DB=formflow
DEV_DB_USER=formflow
DEV_DB_PASS=your_secure_password

# JWT Authentication
JWT_SECRET=your-jwt-secret-key

# Encryption
ENCRYPTION_KEY=your-32-character-encryption-key

# Telegram Auth
TELEGRAM_BOT_TOKEN=your-bot-token
TELEGRAM_BOT_USERNAME=your_bot_username

# Redirect URL
REDIRECT_URL=http://localhost:4200
```

---

## Best Practices

### For Developers

1. **Never commit secrets** - Use `.env.example` template
2. **Rotate keys regularly** - Especially in production
3. **Use strong secrets** - Minimum 32 characters, random generation
4. **Enable HTTPS** - Always use TLS in production
5. **Monitor logs** - Watch for suspicious patterns
6. **Keep dependencies updated** - Regular security patches

### For Administrators

1. **Restrict domain whitelists** - Only add trusted domains
2. **Configure rate limits** - Adjust based on expected traffic
3. **Enable PoW CAPTCHA** - Recommended for public forms
4. **Use CSRF tokens** - Extra layer for sensitive forms
5. **Encrypt sensitive fields** - PII, payment info, etc.
6. **Regular backups** - Database and configuration
7. **Monitor submissions** - Watch for spam patterns

### For Users

1. **Keep API keys private** - Never expose in client-side code
2. **Use environment variables** - Never hardcode keys
3. **Validate on both sides** - Client and server validation
4. **Test security features** - Before production deployment
5. **Report issues** - Responsible disclosure for vulnerabilities

---

## Security Roadmap

### Implemented âœ“

- [x] Rate limiting (per-minute, per-hour, minimum time between)
- [x] Proof of Work CAPTCHA (Alcha)
- [x] CSRF protection
- [x] Domain whitelisting with Referer fallback
- [x] Request body size limits
- [x] Content-Type validation
- [x] Encrypted fields support
- [x] JWT authentication
- [x] Organization-based authorization
- [x] Security headers

### Planned

- [ ] Honeypot field detection
- [ ] User-Agent validation (optional)
- [ ] Advanced pattern detection
- [ ] IP reputation checking
- [ ] Submission similarity detection
- [ ] Webhook signature verification
- [ ] Two-factor authentication
- [ ] API key scoping/permissions

---

## Reporting Security Issues

If you discover a security vulnerability:

1. **DO NOT** open a public GitHub issue
2. Email security details to: security@formflow.fyi
3. Include:
   - Description of vulnerability
   - Steps to reproduce
   - Potential impact
   - Suggested fix (if any)
4. We will respond within 48 hours
5. We will credit researchers upon fix (if desired)

---

## Additional Resources

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [OWASP API Security](https://owasp.org/www-project-api-security/)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)
- [Express Security Best Practices](https://expressjs.com/en/advanced/best-practice-security.html)
