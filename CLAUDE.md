# CLAUDE.md - AI Assistant Context for FormFlow

## Project Overview

FormFlow is a form submission handling platform built as an Nx monorepo. It receives form submissions from websites, processes them through configurable integrations (email, Slack, Telegram, webhooks), and provides a dashboard for management.

## Architecture

```
formflow/
├── apps/
│   ├── collector-api/     # Public API for form submissions (port 3000)
│   ├── dashboard-api/     # Admin API for dashboard (port 4000)
│   ├── dashboard-ui/      # React admin dashboard (port 4100)
│   └── test-lab/          # Development testing UI (port 4200)
├── libs/shared/
│   ├── db/                # Drizzle ORM schema and database client
│   ├── env/               # Environment configuration loader
│   ├── integrations/      # Integration handlers resolver
│   ├── logger/            # Winston logger configuration
│   ├── queue/             # pg-boss job queue and handlers
│   ├── slack/             # Slack API client
│   └── telegram/          # Telegram Bot API client
└── scripts/               # Development and seed scripts
```

## Tech Stack

- **Runtime**: Node.js with TypeScript
- **Monorepo**: Nx
- **Package Manager**: pnpm
- **Database**: PostgreSQL with Drizzle ORM
- **Job Queue**: pg-boss
- **Frontend**: React with Vite, TailwindCSS, shadcn/ui
- **Testing**: Jest (APIs), Vitest (libs), Cypress (E2E)
- **API Framework**: Koa.js

## Key Concepts

### Organizations & Forms
- Organizations are workspaces that contain forms and integrations
- Forms have a unique `submitHash` used for the public submission endpoint
- Forms can use org-level integrations or have form-specific overrides

### Integrations
- **Scope**: `organization` (applies to all forms) or `form` (specific form only)
- **Types**: `webhook`, `slack`, `telegram`, `email-smtp`, `email-api`, `discord`
- Bot tokens (Slack/Telegram) are stored at organization level, not per-integration
- Integration configs only store channel/chat IDs, tokens come from org settings

### Job Queue
- pg-boss handles async processing of integrations
- Each integration type has a dedicated queue handler
- Jobs are created when form submissions are received

## Common Commands

```bash
pnpm dev                    # Start all services in dev mode
pnpm db:up                  # Start PostgreSQL + Mailpit containers
pnpm db:push                # Push Drizzle schema to database
pnpm db:reset               # Reset database and push schema
pnpm seed:integrations      # Seed demo data
pnpm test                   # Run all tests
pnpm test:dashboard-api     # Run dashboard-api tests
pnpm lint                   # Run ESLint
```

## Environment Files

- `.env.development` - Dev environment (gitignored, generated by setup)
- `.env.seed` - Encrypted seed data for integrations (committed)
- `.env.keys` - Decryption keys for dotenvx (gitignored)
- `.env.production` - Production config (gitignored)

## Code Conventions

### TypeScript
- Strict mode enabled
- Use `type` imports for type-only imports
- Prefer interfaces for object shapes, types for unions/intersections
- No implicit any - always type parameters and returns

### Database (Drizzle)
- Schema files in `libs/shared/db/src/lib/schema/`
- Use `db.query.*` for reads with relations
- Use `db.insert/update/delete` for mutations
- Always include `organizationId` in queries for multi-tenancy

### API Controllers
- Controllers are classes with route handler methods
- Use Koa context (`ctx`) for request/response
- Validate input at the start of handlers
- Return JSON responses with appropriate status codes

### React Components
- Functional components with hooks
- shadcn/ui for UI components
- React Query for server state
- Zod for form validation

### Testing
- Unit tests: `*.spec.ts` in same directory as source
- E2E tests: `test/*.e2e.test.ts`
- Mock external services (pg-boss, database) in tests
- Use test fixtures for consistent test data

## File Naming

- `kebab-case` for files and directories
- `PascalCase` for React components
- `camelCase` for functions and variables
- Suffix: `.spec.ts` for unit tests, `.e2e.test.ts` for E2E tests

## Import Aliases

```typescript
import { db } from '@formflow/shared/db';
import { logger } from '@formflow/shared/logger';
import { loadEnv } from '@formflow/shared/env';
import { IntegrationType } from '@formflow/shared/queue';
```

## Security Considerations

- Never log sensitive data (passwords, tokens, PII)
- Bot tokens are stored encrypted in database
- JWT for API authentication
- CSRF protection for form submissions
- Rate limiting per form/IP

## Common Gotchas

1. **Database port**: Dev uses 5433 (not 5432) to avoid conflicts
2. **Bot tokens**: Stored at org level, not in integration config
3. **Form submissions**: Use `submitHash`, not form ID in public endpoints
4. **Queue workers**: Only collector-api runs the queue worker
5. **Migrations**: Use `pnpm db:push` for dev, generate migrations for prod
